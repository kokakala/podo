<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper 
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="reviewMapper">
	
	<resultMap id="reviewSet" type="Review">
		<id property="id" column="id"/>
		<result property="content" column="content"/>
		<result property="inappropriateCount" column="inappropriate_count"/>
		<result property="spoilerCount" column="spoiler_count"/>
		<result property="likeCount" column="LIKE_COUNT"/>
		<result property="spoilerCheck" column="spoiler_check"/>
		<result property="status" column="STATUS"/>
	</resultMap>
	
	<resultMap id="reviewListSet" type="Review">
		<id property="id" column="id"/>
		<result property="userImage" column="image"/>
		<result property="nickName" column="nickname"/>
		<result property="titleKor" column="TITLE_KOR"/>
		<result property="titleEng" column="TITLE_Eng"/>
		<result property="name" column="name"/>
		<result property="releaseYear" column="RELEASE_YEAR"/>
		<result property="content" column="content"/>
		<result property="inappropriateCount" column="INAPPROPRIATE_COUNT"/>
		<result property="spoilerCount" column="SPOILER_COUNT"/>
		<result property="likeCount" column="LIKE_COUNT"/>
		<result property="spoilerCheck" column="SPOILER_CHECK"/>
		<result property="status" column="status"/>
		<result property="modifyDate" column="MODIFY_DATE"/>
	 	<result property="createDate" column="CREATE_DATE"/>
	 	<result property="filmId" column="FILM_ID"/>
	 	<result property="memberId" column="MEMBER_ID"/>
	 	<result property="posterImage" column="change_name"/>
	  	<result property="ratingReviewId" column="rr_id"/>
	 	<result property="ratingSound" column="RATING_SOUND"/>
		<result property="ratingVisual" column="RATING_VISUAL"/>
		<result property="ratingActing" column="RATING_ACTING"/>
		<result property="ratingPop" column="RATING_POP"/>
		<result property="ratingScript" column="RATING_SCRIPT"/>
		<result property="ratingDirect" column="RATING_DIRECT"/>
		<result property="star" column="star"/>
	</resultMap>
	
	
	<resultMap id="ratingReviewSet" type="Review">
		<id property="id" column="id"/>
		<result property="nickName" column="nickname"/>
		<result property="name" column="name"/>
		<result property="ratingSound" column="RATING_SOUND"/>
		<result property="ratingVisual" column="RATING_VISUAL"/>
		<result property="ratingActing" column="RATING_ACTING"/>
		<result property="ratingPop" column="RATING_POP"/>
		<result property="ratingScript" column="RATING_SCRIPT"/>
		<result property="ratingDirect" column="RATING_DIRECT"/>
		<result property="titleKor" column="TITLE_KOR"/>
	 	<result property="userImage" column="IMAGE"/>
	 	<result property="modifyDate" column="MODIFY_DATE"/>
	 	<result property="createDate" column="CREATE_DATE"/>
	 	<result property="star" column="star"/>
	 	<result property="content" column="content"/>
	 	<result property="posterImage" column="change_name"/>
	</resultMap>

	<resultMap type="Film" id="filmResultSet">
		<id property="id" column="id"/>
		<result property="titleKor" column="title_kor"/>
		<result property="titleEng" column="title_eng"/>
		<result property="director" column="director"/>
		<result property="releaseYear" column="release_year"/>
		<result property="productionCountry" column="production_country"/>
		<result property="productionStatus" column="production_status"/>
		<result property="genre" column="name"/>
		<result property="poster" column="change_name"/>
	</resultMap>
	
	<resultMap type="Member" id="memberResultSet">
		<id property="id" column="id"/>
		<result property="image" column="image"/>
		<result property="email" column="email"/>
		<result property="pwd" column="pwd"/>
		<result property="nickName" column="nickname"/>
		<result property="status" column="status"/>
		<result property="enrollDate" column="enroll_date"/>
		<result property="modifyDate" column="modify_date"/>
		<result property="googleId" column="google_id"/>
		<result property="kakaoId" column="kakao_id"/>
		<result property="autho" column="autho"/>
	</resultMap>
	
	<resultMap type="Review" id="myPageSelectReviewListResultSet">
		<id property="id" column="id"/>
		<result property="memberId" column="MEMBER_ID"/>
		<result property="content" column="content"/>
		<result property="titleKor" column="TITLE_KOR"/>
		<result property="filmId" column="f_id"/>
		<result property="status" column="status"/>
		<result property="modifyDate" column="MODIFY_DATE"/>
		<result property="posterImage" column="change_name"/>
	</resultMap>
	
	<select id="getReviewListCount" resultType="_int">
		select count(*)
		from tb_review r
		where r.status='Y'
	</select> 
	
	<select id="selectReviewList" resultMap="reviewListSet">	
        select *
		from tb_review r
		left join tb_film f on(r.film_id = f.id)
        left join tb_member m on(r.member_id = m.id)
		left join tb_detail_film df on(r.film_id = df.id)
		left join tb_film_image fi on(df.film_id = fi.id)
		left join tb_rating_review rr on(r.film_id=rr.id)
		left join tb_genre g on(genre_id = g.id)
        left join tb_rating_film rf on(f.id = rf.id)
		where r.status='Y'
        order by r.id desc
	</select>
	
	<insert id="reviewWrite">
		INSERT INTO TB_REVIEW
		VALUES(SEQ_REVIEW_ID.NEXTVAL, #{content}, DEFAULT, DEFAULT, DEFAULT, DEFAULT, DEFAULT, sysdate , sysdate , #{filmId},#{memberId})
	</insert>  
	
	<insert id="reviewRating">
		INSERT INTO TB_RATING_REVIEW
		VALUES (SEQ_RATING_REVIEW_ID.NEXTVAL,#{ratingSound},#{ratingVisual},#{ratingActing},#{ratingPop},#{ratingScript},#{ratingDirect}, SEQ_REVIEW_ID.currval,#{memberId})
	</insert> 
	
	<!-- 리뷰업데이트 관련 -->
	<update id="reviewUpdateContent">
		update tb_review
		set CONTENT=#{content},MODIFY_DATE=sysdate
		where id=#{id}
	</update>
	<!-- 리뷰 레이팅리뷰 업데이트관련 -->
	<update id="reviewUpdate">
		update tb_rating_review
		set rating_Sound=#{ratingSound},rating_Visual=#{ratingVisual},rating_Acting=#{ratingActing},rating_Pop=#{ratingPop},rating_Script=#{ratingScript},rating_Direct=#{ratingDirect}
		where id=#{ratingReviewId}
	</update>
	
	<!-- 리뷰삭제 -->
	<update id="deleteReview">
	update tb_review
	set status='N'
	where id=#{id}
	</update>
	
	<!-- 영화제목 장르 가져오는거 -->
	<select id="selectFilm" resultMap="filmResultSet">
        SELECT *
		FROM TB_FILM f
        left join tb_genre g on( f.genre_id = g.id)
        left join tb_detail_film df on(df.film_id=f.id)
        left join TB_FILM_IMAGE fi on(fi.DFILM_ID=df.id)
        where f.id=#{id}
	</select>
	
	<!-- 멤버정보 가져오는거 -->
	<select id="selectMember" resultMap="memberResultSet">
		select *
        from tb_member
        where id=#{id}
	</select>
	
	<!-- 합친부분 -->
	<select id="selectRatingReviewDetailView" resultMap="reviewListSet">
      select r.id as id,m.image, fi.change_name,f.title_kor,rf.star,r.modify_date,r.create_date,m.nickname,r.content,rr.rating_Sound,rr.rating_Visual,rr.rating_Acting,rr.rating_Pop,rr.rating_Script,rr.rating_Direct,rr.id as rr_id
      from  TB_REVIEW r
      left join tb_rating_review rr on (rr.review_id = r.id)
      left join TB_FILM f on (r.film_id = f.id)
      left join tb_member m on(r.member_id = m.id)
      left join tb_rating_film rf on(r.film_id=rf.id)
      left join tb_detail_film df on(r.film_id = df.id)
      left join tb_film_image fi on(df.film_id = fi.id)
      left join tb_genre g on(genre_id = g.id)
      where r.id=#{id}
	</select>

	
	
	
	<select id="myPageReviewListCount" resultType="_int">
		select count(*)
		from tb_review
		where member_id=#{id}
	</select>
	
	<select id="myPageSelectReviewList" resultMap="myPageSelectReviewListResultSet">
		select member_id, content, title_kor, f.id as f_id, status, modify_date, change_name
		from tb_review 
		join tb_film f on(film_id = f.id)
		join (select film_id, change_name
		from tb_detail_film df
		join tb_film_image i on(i.dfilm_id = df.id))b on(b.film_id=f.id)
		where member_id=#{id} and
		status='Y'
		order by modify_date desc
	</select>
	

	<select id="selectReviewListMain" resultMap="reviewListSet">
	<![CDATA[	
        select rownum, r.*
		from (select * from tb_review r
		left join tb_film f on(r.film_id = f.id)
        left join tb_member m on(r.member_id = m.id)
		left join tb_detail_film df on(r.film_id = df.id)
		left join tb_film_image fi on(df.film_id = fi.id)
		left join tb_rating_review rr on(r.film_id=rr.id)
		left join tb_genre g on(genre_id = g.id)
        left join tb_rating_film rf on(f.id = rf.id)
		where r.status='Y'
        order by r.like_count desc) r
        where rownum <=3
     ]]>
	</select>

	<!-- 리뷰가져오는거 -->
<!-- 	<select id="selectReview" resultMap="reviewListSet">
        SELECT *
		FROM TB_Review r
		where 
	</select>
 -->
	
	
</mapper>